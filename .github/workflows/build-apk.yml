name: Build Android APK

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-apk:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'  # Includes Dart 3.5.0
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Decode google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -n "$GOOGLE_SERVICES_JSON" ]; then
            echo "$GOOGLE_SERVICES_JSON" | base64 --decode > android/app/google-services.json
            echo "✅ google-services.json decoded successfully"
          else
            echo "⚠️ GOOGLE_SERVICES_JSON secret not found, using placeholder"
            echo '{"project_info":{"project_number":"","project_id":"nextwave-placeholder"}}' > android/app/google-services.json
          fi

      - name: Build APK (Debug)
        run: flutter build apk --debug --split-per-abi

      - name: Build APK (Release)
        run: flutter build apk --release --split-per-abi

      - name: Upload Debug APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-apks
          path: |
            build/app/outputs/flutter-apk/app-*-debug.apk
          retention-days: 14

      - name: Upload Release APK Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-apks
          path: |
            build/app/outputs/flutter-apk/app-*-release.apk
          retention-days: 30

      - name: Create Release Info
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "## 📱 APK Build Info" > release-info.md
          echo "" >> release-info.md
          echo "**Branch:** ${{ github.ref_name }}" >> release-info.md
          echo "**Commit:** ${{ github.sha }}" >> release-info.md
          echo "**Build Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> release-info.md
          echo "" >> release-info.md
          echo "### APK Files" >> release-info.md
          echo "- Debug APKs: Available in artifacts" >> release-info.md
          echo "- Release APKs: Available in artifacts" >> release-info.md
          echo "" >> release-info.md
          echo "Download from the Actions artifacts above ⬆️" >> release-info.md

      - name: Upload Release Info
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: release-info.md
          retention-days: 30

      - name: Build Summary
        if: always()
        run: |
          echo "### 🎉 Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### APK Files Generated:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "build/app/outputs/flutter-apk" ]; then
            echo "**Debug APKs:**" >> $GITHUB_STEP_SUMMARY
            ls -lh build/app/outputs/flutter-apk/app-*-debug.apk 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- No debug APKs found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Release APKs:**" >> $GITHUB_STEP_SUMMARY
            ls -lh build/app/outputs/flutter-apk/app-*-release.apk 2>/dev/null | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- No release APKs found" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Build directory not found" >> $GITHUB_STEP_SUMMARY
          fi
